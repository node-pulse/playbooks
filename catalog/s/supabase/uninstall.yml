---
- name: Uninstall Supabase Self-Hosted
  hosts: all
  become: true
  vars:
    supabase_install_dir: "{{ supabase_install_dir | default('/opt/supabase') }}"

  tasks:
    - name: Check if Supabase installation exists
      ansible.builtin.stat:
        path: "{{ supabase_install_dir }}/compose.yml"
      register: supabase_exists

    - name: Stop and remove Supabase containers via Docker Compose
      ansible.builtin.command: docker compose down -v
      args:
        chdir: "{{ supabase_install_dir }}"
      when: supabase_exists.stat.exists
      failed_when: false

    - name: Force remove Supabase containers (in case of conflicts)
      ansible.builtin.shell: |
        docker rm -f supabase-studio supabase-kong supabase-auth supabase-rest \
          supabase-realtime supabase-storage supabase-imgproxy supabase-meta \
          supabase-edge-functions supabase-analytics supabase-db supabase-vector \
          supabase-pooler 2>/dev/null || true
        docker network rm supabase_default 2>/dev/null || true
      failed_when: false
      changed_when: false

    - name: Remove Supabase Docker images
      ansible.builtin.command: docker compose down --rmi all
      args:
        chdir: "{{ supabase_install_dir }}"
      when: supabase_exists.stat.exists
      failed_when: false

    - name: Prompt for data deletion
      ansible.builtin.pause:
        prompt: |

          WARNING: Do you want to delete all Supabase data including database?
          This action is irreversible and will delete:
            - PostgreSQL database and all data
            - File storage uploads
            - Edge Functions
            - All configuration files

          Type 'yes' to confirm data deletion, or 'no' to keep data
      register: delete_data_prompt
      when: supabase_exists.stat.exists

    - name: Remove Supabase data directories
      ansible.builtin.file:
        path: "{{ supabase_install_dir }}/volumes"
        state: absent
      when:
        - supabase_exists.stat.exists
        - delete_data_prompt.user_input | default('no') | lower == 'yes'

    - name: Remove Supabase installation directory
      ansible.builtin.file:
        path: "{{ supabase_install_dir }}"
        state: absent
      when: supabase_exists.stat.exists

    - name: Remove Nginx configuration (Debian/Ubuntu)
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/nginx/sites-enabled/supabase
        - /etc/nginx/sites-available/supabase
      when: ansible_os_family == "Debian"
      failed_when: false

    - name: Remove Nginx configuration (RHEL/CentOS/Rocky/Alma)
      ansible.builtin.file:
        path: /etc/nginx/conf.d/supabase.conf
        state: absent
      when: ansible_os_family == "RedHat"
      failed_when: false

    - name: Test Nginx configuration
      ansible.builtin.command: nginx -t
      register: nginx_test
      failed_when: false
      changed_when: false

    - name: Reload Nginx if configuration is valid
      ansible.builtin.systemd:
        name: nginx
        state: reloaded
      when: nginx_test.rc == 0
      failed_when: false

    - name: Remove SSL certificates
      ansible.builtin.command: certbot delete --cert-name {{ supabase_domain }} --non-interactive
      when:
        - supabase_domain is defined
        - supabase_domain | length > 0
      failed_when: false

    - name: Remove Certbot cron job
      ansible.builtin.cron:
        name: "Renew Let's Encrypt certificates"
        state: absent
      failed_when: false

    - name: Display uninstall summary
      ansible.builtin.debug:
        msg:
          - "Supabase Self-Hosted has been uninstalled!"
          - "=========================================="
          - "Removed:"
          - "  - All Docker containers (13 services)"
          - "  - Docker images"
          - "  - Configuration files"
          - "  - Nginx configurations"
          - "  - SSL certificates (if domain was provided)"
          - "  - Certbot renewal cron job"
          - "{{ '  - All data (database, storage, functions)' if (delete_data_prompt.user_input | default('no') | lower == 'yes') else '  - Data preserved in ' + supabase_install_dir + '/volumes' }}"
          - ""
          - "NOT removed (manual cleanup required if desired):"
          - "  - Docker"
          - "  - Nginx"
          - "  - Certbot"
          - ""
          - "To completely remove all components:"
          - "  Docker: apt remove docker-ce docker-ce-cli containerd.io (Debian/Ubuntu)"
          - "          dnf remove docker-ce docker-ce-cli containerd.io (RHEL 8+/Rocky/Alma)"
          - "  Nginx:  apt remove nginx (Debian/Ubuntu)"
          - "          dnf remove nginx (RHEL 8+/Rocky/Alma)"
          - "  Certbot: apt remove certbot python3-certbot-nginx (Debian/Ubuntu)"
          - "           dnf remove certbot python3-certbot-nginx (RHEL 8+/Rocky/Alma)"
      when: supabase_exists.stat.exists

    - name: Display message if Supabase not found
      ansible.builtin.debug:
        msg: "Supabase installation not found at {{ supabase_install_dir }}"
      when: not supabase_exists.stat.exists
