# Vector Log Collection Configuration for Supabase
# Generated by Node Pulse Admiral

api:
  enabled: true
  address: 0.0.0.0:9001

sources:
  docker_host:
    type: docker_logs
    docker_host: /var/run/docker.sock
    exclude_containers:
      - supabase-vector

transforms:
  project_logs:
    type: remap
    inputs:
      - docker_host
    source: |-
      .project = "default"
      .event_message = del(.message)
      .appname = del(.container_name)
      del(.container_created_at)
      del(.container_id)
      del(.source_type)
      del(.stream)
      del(.label)
      del(.image)
      del(.host)
      del(.timestamp)

  router:
    type: route
    inputs:
      - project_logs
    route:
      kong: '.appname == "supabase-kong"'
      auth: '.appname == "supabase-auth"'
      rest: '.appname == "supabase-rest"'
      realtime: '.appname == "supabase-realtime"'
      storage: '.appname == "supabase-storage"'
      functions: '.appname == "supabase-edge-functions"'
      db: '.appname == "supabase-db"'
      studio: '.appname == "supabase-studio"'
      pooler: '.appname == "supabase-pooler"'

  # Kong logs
  kong_logs:
    type: remap
    inputs:
      - router.kong
    source: |-
      parsed, err = parse_json(.event_message)
      if err == null {
        .metadata.request.cf.asOrganization = parsed.request.headers.cf-ipcountry
        .metadata.request.cf.asn = parsed.request.headers.cf-ray
        .metadata.request.headers.cf_connecting_ip = parsed.request.headers.cf-connecting-ip
        .metadata.request.headers.x_real_ip = parsed.request.headers.x-real-ip
        .metadata.request.method = parsed.request.method
        .metadata.request.path = parsed.request.uri
        .metadata.request.protocol = parsed.request.protocol
        .metadata.request.headers.x_forwarded_proto = parsed.request.headers.x-forwarded-proto
        .metadata.response.status_code = parsed.response.status
        .metadata.response.headers.cf_cache_status = parsed.response.headers.cf-cache-status
      }

  # Auth logs
  auth_logs:
    type: remap
    inputs:
      - router.auth
    source: |-
      parsed, err = parse_json(.event_message)
      if err == null {
        .metadata.level = parsed.level
        .metadata.msg = parsed.msg
        .metadata.component = parsed.component
      }

  # Realtime logs
  realtime_logs:
    type: remap
    inputs:
      - router.realtime
    source: |-
      .metadata.project = "default"
      .metadata.external_id = "default"

  # PostgREST logs
  rest_logs:
    type: remap
    inputs:
      - router.rest
    source: |-
      parsed, err = parse_json(.event_message)
      if err == null {
        .metadata.level = parsed.level
        .metadata.msg = parsed.message
      }

  # Storage logs
  storage_logs:
    type: remap
    inputs:
      - router.storage
    source: |-
      parsed, err = parse_json(.event_message)
      if err == null {
        .metadata.level = parsed.level
        .metadata.msg = parsed.msg
        .metadata.reqId = parsed.reqId
      }

  # Functions logs
  functions_logs:
    type: remap
    inputs:
      - router.functions
    source: |-
      parsed, err = parse_json(.event_message)
      if err == null {
        .metadata.msg = parsed.msg
        .metadata.level = parsed.level
      }

  # Database logs
  db_logs:
    type: remap
    inputs:
      - router.db
    source: |-
      .metadata.host = "db-default"

  # Studio logs
  studio_logs:
    type: remap
    inputs:
      - router.studio
    source: |-
      parsed, err = parse_json(.event_message)
      if err == null {
        .metadata.level = parsed.level
        .metadata.msg = parsed.msg
      }

  # Pooler logs
  pooler_logs:
    type: remap
    inputs:
      - router.pooler
    source: |-
      parsed, err = parse_json(.event_message)
      if err == null {
        .metadata.level = parsed.level
        .metadata.msg = parsed.message
      }

sinks:
  logflare_kong:
    type: "http"
    inputs:
      - kong_logs
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_max_duration_secs: 10
    uri: "http://analytics:4000/api/logs?source_name=kong_logs&api_key={{ logflare_api_key }}"

  logflare_auth:
    type: "http"
    inputs:
      - auth_logs
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_max_duration_secs: 10
    uri: "http://analytics:4000/api/logs?source_name=gotrue_logs&api_key={{ logflare_api_key }}"

  logflare_realtime:
    type: "http"
    inputs:
      - realtime_logs
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_max_duration_secs: 10
    uri: "http://analytics:4000/api/logs?source_name=realtime_logs&api_key={{ logflare_api_key }}"

  logflare_rest:
    type: "http"
    inputs:
      - rest_logs
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_max_duration_secs: 10
    uri: "http://analytics:4000/api/logs?source_name=postgrest_logs&api_key={{ logflare_api_key }}"

  logflare_storage:
    type: "http"
    inputs:
      - storage_logs
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_max_duration_secs: 10
    uri: "http://analytics:4000/api/logs?source_name=storage_logs&api_key={{ logflare_api_key }}"

  logflare_functions:
    type: "http"
    inputs:
      - functions_logs
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_max_duration_secs: 10
    uri: "http://analytics:4000/api/logs?source_name=deno_relay_logs&api_key={{ logflare_api_key }}"

  logflare_db:
    type: "http"
    inputs:
      - db_logs
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_max_duration_secs: 10
    uri: "http://analytics:4000/api/logs?source_name=postgres_logs&api_key={{ logflare_api_key }}"

  logflare_studio:
    type: "http"
    inputs:
      - studio_logs
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_max_duration_secs: 10
    uri: "http://analytics:4000/api/logs?source_name=studio_logs&api_key={{ logflare_api_key }}"

  logflare_pooler:
    type: "http"
    inputs:
      - pooler_logs
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_max_duration_secs: 10
    uri: "http://analytics:4000/api/logs?source_name=pooler_logs&api_key={{ logflare_api_key }}"
