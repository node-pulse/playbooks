---
- name: Update PostgreSQL Stack Configuration
  hosts: all
  become: true
  vars:
    # Hardcoded paths
    install_dir: "/opt/pgstack"
    data_dir: "/opt/pgstack/data"
    project_name: "pgstack"

    # Hardcoded service paths
    pgweb_path: "/pgweb"
    postgrest_path: "/postgrest"
    auth_path: "/auth"
    authelia_path: "/authelia"

    # Hardcoded ports
    postgres_port: 5432
    postgrest_port: 3000
    pgweb_port: 8081
    authelia_port: 9091
    auth_port: 5000

    # Hardcoded database settings
    postgres_db: "postgres"
    postgres_user: "postgres"
    postgrest_role: "authenticator"
    postgrest_anon_role: "anon"

    # SSL always enabled
    enable_ssl: true

  tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - domain is defined
          - domain | length > 0
        fail_msg: "Missing required variable: domain"

    - name: Check if installation exists
      ansible.builtin.stat:
        path: "{{ install_dir }}/compose.yml"
      register: install_check

    - name: Fail if installation not found
      ansible.builtin.fail:
        msg: |
          ERROR: PostgreSQL Stack installation not found at {{ install_dir }}
          Run install.yml first: ansible-playbook install.yml -e domain={{ domain }} -e admin_email=you@example.com
      when: not install_check.stat.exists

    - name: Display update information
      ansible.builtin.debug:
        msg:
          - "Updating PostgreSQL Stack at {{ install_dir }}"
          - "Domain: {{ domain }}"

    # Load existing credentials from .env
    - name: Load existing credentials from .env
      ansible.builtin.shell: |
        set -o pipefail
        grep '^{{ item }}=' {{ install_dir }}/.env | cut -d= -f2
      register: existing_credentials
      loop:
        - POSTGRES_PASSWORD
        - POSTGREST_PASSWORD
        - POSTGREST_JWT_SECRET
        - AUTHELIA_JWT_SECRET
        - AUTHELIA_SESSION_SECRET
        - AUTHELIA_STORAGE_ENCRYPTION_KEY
        - API_USER_NAME
        - API_USER_PASSWORD
        - API_ADMIN_NAME
        - API_ADMIN_PASSWORD
      changed_when: false
      failed_when: false

    - name: Set credentials from existing .env
      ansible.builtin.set_fact:
        postgres_password: "{{ existing_credentials.results[0].stdout }}"
        postgrest_password: "{{ existing_credentials.results[1].stdout }}"
        postgrest_jwt_secret: "{{ existing_credentials.results[2].stdout }}"
        authelia_jwt_secret: "{{ existing_credentials.results[3].stdout }}"
        authelia_session_secret: "{{ existing_credentials.results[4].stdout }}"
        authelia_storage_encryption_key: "{{ existing_credentials.results[5].stdout }}"
        api_user_name: "{{ existing_credentials.results[6].stdout | default('api_user', true) }}"
        api_user_password: "{{ existing_credentials.results[7].stdout }}"
        api_admin_name: "{{ existing_credentials.results[8].stdout | default('api_admin', true) }}"
        api_admin_password: "{{ existing_credentials.results[9].stdout }}"

    # Load existing Authelia password hash and admin email
    - name: Load existing Authelia password hash
      ansible.builtin.shell: |
        set -o pipefail
        grep -oE '\$argon2id\$v=[0-9]+\$m=[0-9]+,t=[0-9]+,p=[0-9]+\$[A-Za-z0-9+/]+\$[A-Za-z0-9+/]+' {{ install_dir }}/authelia-users.yml | head -1
      register: existing_authelia_hash
      changed_when: false
      failed_when: false

    - name: Load existing admin email from authelia-users.yml
      ansible.builtin.shell: |
        set -o pipefail
        grep 'email:' {{ install_dir }}/authelia-users.yml | head -1 | sed 's/.*email:[[:space:]]*["'\'']\?\([^"'\'']*\)["'\'']\?.*/\1/'
      register: existing_admin_email
      changed_when: false
      failed_when: false

    - name: Set Authelia admin password hash and email
      ansible.builtin.set_fact:
        authelia_admin_password_hash: "{{ existing_authelia_hash.stdout }}"
        admin_email: "{{ existing_admin_email.stdout | default('admin@localhost', true) }}"

    # Update configuration files
    - name: Update .env file
      ansible.builtin.template:
        src: templates/env.j2
        dest: "{{ install_dir }}/.env"
        mode: '0600'
      register: env_updated

    - name: Update compose.yml
      ansible.builtin.template:
        src: templates/compose.yml.j2
        dest: "{{ install_dir }}/compose.yml"
        mode: '0644'
      register: compose_updated

    - name: Update PostgREST configuration
      ansible.builtin.template:
        src: templates/postgrest.conf.j2
        dest: "{{ install_dir }}/postgrest.conf"
        mode: '0644'
      register: postgrest_conf_updated

    - name: Update Authelia configuration
      ansible.builtin.template:
        src: templates/authelia-config.yml.j2
        dest: "{{ install_dir }}/authelia-config.yml"
        mode: '0600'
      register: authelia_config_updated

    - name: Update Authelia users database
      ansible.builtin.template:
        src: templates/authelia-users.yml.j2
        dest: "{{ install_dir }}/authelia-users.yml"
        mode: '0600'
      register: authelia_users_updated

    - name: Update PostgreSQL init script
      ansible.builtin.template:
        src: templates/init-postgrest.sql.j2
        dest: "{{ install_dir }}/init-postgrest.sql"
        mode: '0644'

    - name: Update Auth service Python script
      ansible.builtin.template:
        src: templates/auth-service.py.j2
        dest: "{{ install_dir }}/auth-service.py"
        mode: '0755'
      register: auth_service_updated

    - name: Update Auth service requirements file
      ansible.builtin.template:
        src: templates/auth-requirements.txt.j2
        dest: "{{ install_dir }}/auth-requirements.txt"
        mode: '0644'

    - name: Update Auth service Dockerfile
      ansible.builtin.template:
        src: templates/Dockerfile.auth.j2
        dest: "{{ install_dir }}/Dockerfile.auth"
        mode: '0644'
      register: auth_dockerfile_updated

    # Update Nginx configuration
    - name: Update Nginx HTTPS configuration (Debian/Ubuntu)
      ansible.builtin.template:
        src: templates/nginx-https-postgresql-stack.conf.j2
        dest: "/etc/nginx/sites-available/{{ project_name }}"
        mode: '0644'
        force: true
      when: ansible_os_family == "Debian"
      register: nginx_updated_debian

    - name: Update Nginx HTTPS configuration (RHEL)
      ansible.builtin.template:
        src: templates/nginx-https-postgresql-stack.conf.j2
        dest: "/etc/nginx/conf.d/{{ project_name }}.conf"
        mode: '0644'
        force: true
      when: ansible_os_family == "RedHat"
      register: nginx_updated_rhel

    - name: Test Nginx configuration
      ansible.builtin.command: nginx -t
      changed_when: false

    - name: Reload Nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded
      when: nginx_updated_debian.changed or nginx_updated_rhel.changed

    # Restart services if needed
    - name: Restart Docker containers if configuration changed
      ansible.builtin.command: docker compose up -d
      args:
        chdir: "{{ install_dir }}"
      when: >
        env_updated.changed or
        compose_updated.changed or
        postgrest_conf_updated.changed or
        authelia_config_updated.changed or
        authelia_users_updated.changed or
        auth_service_updated.changed or
        auth_dockerfile_updated.changed
      register: docker_restart
      changed_when: "'Started' in docker_restart.stderr or 'Recreated' in docker_restart.stderr"

    - name: Wait for Authelia to be ready
      ansible.builtin.uri:
        url: "http://localhost:{{ authelia_port }}/api/health"
        status_code: 200
      register: authelia_health
      until: authelia_health.status == 200
      retries: 30
      delay: 5

    # Check if TOTP already exists for admin user
    - name: Check if TOTP is configured for admin user
      ansible.builtin.shell: |
        docker exec {{ project_name }}-authelia authelia storage user totp export uri \
          --config /config/configuration.yml \
          --users "{{ admin_email }}" 2>&1
      register: totp_check_result
      changed_when: false
      failed_when: false

    - name: Set TOTP exists flag
      ansible.builtin.set_fact:
        totp_exists: "{{ 'otpauth://' in totp_check_result.stdout }}"

    # Generate TOTP if not exists
    - name: Generate TOTP secret for admin user
      ansible.builtin.shell: |
        docker exec {{ project_name }}-authelia authelia storage user totp generate \
          --config /config/configuration.yml \
          "{{ admin_email }}" 2>&1
      register: totp_generate_result
      changed_when: true
      failed_when: false
      when: not totp_exists

    - name: Extract TOTP secret from output
      ansible.builtin.set_fact:
        totp_secret: "{{ totp_generate_result.stdout | regex_search('secret=([A-Z2-7]+)', '\\1') | first | default('') }}"
      when:
        - not totp_exists
        - totp_generate_result.stdout is defined

    - name: Display update summary
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "PostgreSQL Stack update complete!"
          - "============================================"
          - ""
          - "Base URL: https://{{ domain }}"
          - ""
          - "Services:"
          - "  pgweb:     https://{{ domain }}/pgweb/"
          - "  PostgREST: https://{{ domain }}/postgrest/"
          - "  Auth:      https://{{ domain }}/auth/"
          - "  Authelia:  https://{{ domain }}/authelia/"
          - ""
          - "Authelia Login: {{ admin_email }}"
          - "============================================"

    - name: Display TOTP setup instructions (new TOTP generated)
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "NEW: TOTP 2FA has been configured!"
          - "============================================"
          - ""
          - "TOTP Secret: {{ totp_secret }}"
          - ""
          - "Setup in Google Authenticator:"
          - "  1. Open Google Authenticator (or Authy, etc.)"
          - "  2. Tap '+' > 'Enter a setup key'"
          - "  3. Account name: {{ admin_email }}"
          - "  4. Your key: {{ totp_secret }}"
          - "  5. Key type: Time-based (default)"
          - "  6. Tap 'Add'"
          - ""
          - "SAVE THIS SECRET!"
          - "============================================"
      when:
        - not totp_exists
        - totp_secret is defined
        - totp_secret | length > 0

    - name: Display TOTP already configured message
      ansible.builtin.debug:
        msg:
          - "TOTP: Already configured (no changes)"
      when: totp_exists
