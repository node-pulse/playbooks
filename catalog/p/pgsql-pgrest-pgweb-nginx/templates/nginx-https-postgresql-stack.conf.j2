server {
    listen 80;
    listen [::]:80;
    server_name {{ domain }};

    # Redirect HTTP to HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name {{ domain }};

    # SSL Configuration (managed by Certbot)
    ssl_certificate /etc/letsencrypt/live/{{ domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ domain }}/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Logging
    access_log /var/log/nginx/{{ project_name }}-access.log;
    error_log /var/log/nginx/{{ project_name }}-error.log;

    # Authelia authentication endpoint (internal only)
    # Using auth-request endpoint for NGINX (not forward-auth which is for Traefik/Caddy)
    location /authelia-verify {
        internal;
        proxy_pass http://127.0.0.1:{{ authelia_port }}/api/authz/auth-request;
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Content-Length "";
        proxy_pass_request_body off;
    }

    # Authelia portal - 2FA login page
    # Authelia is configured with server.path, so we proxy to the root
    # and Authelia handles the subpath internally
    location {{ authelia_path }}/ {
        proxy_pass http://127.0.0.1:{{ authelia_port }}/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-URI $request_uri;
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
    }

    # Authelia without trailing slash - redirect to with slash
    location = {{ authelia_path }} {
        return 301 $scheme://$host{{ authelia_path }}/;
    }

    # Authelia static assets - Authelia serves these at root path regardless of subpath config
    location /static/ {
        proxy_pass http://127.0.0.1:{{ authelia_port }}/static/;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_hide_header Cache-Control;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    location = /manifest.json {
        proxy_pass http://127.0.0.1:{{ authelia_port }}/manifest.json;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /locales/ {
        proxy_pass http://127.0.0.1:{{ authelia_port }}/locales/;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Authelia API - needed when using server.path config
    location /api/ {
        proxy_pass http://127.0.0.1:{{ authelia_port }}/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-URI $request_uri;
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
    }

    # pgweb - protected by Authelia
    location {{ pgweb_path }}/ {
        # Authelia authentication
        auth_request /authelia-verify;
        auth_request_set $user $upstream_http_remote_user;
        auth_request_set $groups $upstream_http_remote_groups;
        auth_request_set $name $upstream_http_remote_name;
        auth_request_set $email $upstream_http_remote_email;

        # Redirect to Authelia login if not authenticated
        error_page 401 = @authelia_redirect;

        # Proxy to pgweb
        proxy_pass http://127.0.0.1:{{ pgweb_port }}/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Pass auth headers to backend
        proxy_set_header Remote-User $user;
        proxy_set_header Remote-Groups $groups;
        proxy_set_header Remote-Name $name;
        proxy_set_header Remote-Email $email;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # PostgREST API - requires JWT token (no Authelia, uses JWT auth)
    location {{ postgrest_path }}/ {
        proxy_pass http://127.0.0.1:{{ postgrest_port }}/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Increase timeouts for long-running queries
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Pass through headers
        proxy_pass_request_headers on;
    }

    # Auth service - JWT token generation
    location {{ auth_path }}/ {
        proxy_pass http://127.0.0.1:{{ auth_port }}/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Increase timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Authelia redirect location
    location @authelia_redirect {
        return 302 https://{{ domain }}{{ authelia_path }}/?rd=$scheme://$http_host$request_uri;
    }


    # Root location - redirect to pgweb
    location = / {
        return 302 $scheme://$host{{ pgweb_path }}/;
    }
}
