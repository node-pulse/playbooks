services:
  pg:
    image: postgres:{{ postgres_version }}
    container_name: {{ n8n_instance_name }}-pg
    restart: always
    environment:
      - POSTGRES_USER={{ postgres_user }}
      - POSTGRES_PASSWORD={{ postgres_password }}
      - POSTGRES_DB={{ postgres_db }}
    volumes:
      - {{ n8n_data_dir }}/pg_data:/var/lib/postgresql/data
      - {{ n8n_data_dir }}/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - {{ n8n_instance_name }}-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ postgres_user }}"]
      interval: 10s
      timeout: 5s
      retries: 5

  n8n:
    image: n8nio/n8n:{{ n8n_version }}
    container_name: {{ n8n_instance_name }}
    restart: always
{% if n8n_domain == "" %}
    ports:
      - "{{ n8n_port }}:5678"
{% else %}
    ports:
      - "127.0.0.1:{{ n8n_port }}:5678"
{% endif %}
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=pg
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE={{ postgres_db }}
      - DB_POSTGRESDB_USER={{ postgres_user }}
      - DB_POSTGRESDB_PASSWORD={{ postgres_password }}
      - N8N_PORT=5678
      - GENERIC_TIMEZONE={{ n8n_timezone }}
      - N8N_LISTEN_ADDRESS=0.0.0.0
{% if n8n_domain != "" %}
      - N8N_HOST={{ n8n_domain }}
      - N8N_PROTOCOL={{ 'https' if enable_ssl else 'http' }}
      - WEBHOOK_URL={{ n8n_webhook_url }}
      - N8N_EDITOR_BASE_URL={{ n8n_webhook_url }}
{% else %}
      - N8N_HOST={{ ansible_default_ipv4.address }}
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://{{ ansible_default_ipv4.address }}:{{ n8n_port }}/
      - N8N_EDITOR_BASE_URL=http://{{ ansible_default_ipv4.address }}:{{ n8n_port }}/
{% endif %}
      - NODE_ENV=production
      - N8N_ENCRYPTION_KEY={{ n8n_encryption_key }}
      - N8N_USER_MANAGEMENT_JWT_SECRET={{ n8n_jwt_secret }}
      - N8N_SECURE_COOKIE={{ 'true' if enable_ssl else 'false' }}
      - N8N_USER_MANAGEMENT_DISABLED=false
      - N8N_LOG_LEVEL=info
      - N8N_LOG_FORMAT=json
      - N8N_LOG_OUTPUT=console
      - EXECUTIONS_TIMEOUT=600
      - N8N_RUNNERS_TASK_TIMEOUT=600
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=168
{% if n8n_basic_auth_user != "" and n8n_basic_auth_password != "" %}
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER={{ n8n_basic_auth_user }}
      - N8N_BASIC_AUTH_PASSWORD={{ n8n_basic_auth_password }}
{% endif %}
    volumes:
      - {{ n8n_data_dir }}/n8n_data:/home/node/.n8n
      - {{ n8n_data_dir }}/n8n_files:/files
    depends_on:
      pg:
        condition: service_healthy
    networks:
      - {{ n8n_instance_name }}-network

{% if n8n_domain != "" %}
  caddy:
    build:
      context: {{ n8n_data_dir }}/caddy
      dockerfile: Dockerfile
    container_name: {{ n8n_instance_name }}-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - {{ n8n_data_dir }}/caddy_data:/data
      - {{ n8n_data_dir }}/caddy_config:/config
      - {{ n8n_data_dir }}/caddy/Caddyfile:/etc/caddy/Caddyfile
    depends_on:
      - n8n
    networks:
      - {{ n8n_instance_name }}-network
{% endif %}

networks:
  {{ n8n_instance_name }}-network:
    driver: bridge

volumes:
  n8n_data:
  n8n_files:
  pg_data:
{% if n8n_domain != "" %}
  caddy_data:
  caddy_config:
{% endif %}
